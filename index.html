<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordinazioni - Bar Ristorante</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #2c5530;
            --secondary-color: #e8f5e8;
            --accent-color: #f39c12;
            --text-color: #333;
            --light-color: #fff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: var(--light-color);
            padding: 20px 0;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
        }
        
        .tabs {
            display: flex;
            background-color: var(--secondary-color);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            transition: background-color 0.3s;
            flex: 1;
            text-align: center;
        }
        
        .tab.active {
            background-color: var(--primary-color);
            color: var(--light-color);
        }
        
        .tab:hover:not(.active) {
            background-color: rgba(44, 85, 48, 0.1);
        }
        
        .tab-content {
            display: none;
            background-color: var(--light-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .menu-item {
            background-color: var(--light-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
        }
        
        .menu-item:hover {
            transform: translateY(-5px);
        }
        
        .menu-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .menu-item-content {
            padding: 15px;
        }
        
        .menu-item-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .menu-item-price {
            color: var(--accent-color);
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .add-to-order {
            background-color: var(--primary-color);
            color: var(--light-color);
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s;
        }
        
        .add-to-order:hover {
            background-color: #1e3a21;
        }
        
        .order-summary {
            background-color: var(--light-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .order-items {
            margin-bottom: 15px;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .order-total {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            font-size: 18px;
            padding-top: 10px;
            border-top: 2px solid #eee;
        }
        
        .order-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: var(--light-color);
        }
        
        .btn-primary:hover {
            background-color: #1e3a21;
        }
        
        .btn-secondary {
            background-color: #e0e0e0;
            color: var(--text-color);
        }
        
        .btn-secondary:hover {
            background-color: #d0d0d0;
        }
        
        .orders-list {
            display: grid;
            gap: 15px;
        }
        
        .order-card {
            background-color: var(--light-color);
            border-radius: 8px;
            padding: 15px;
            box-shadow: var(--shadow);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .order-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-preparing {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .status-ready {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-completed {
            background-color: #e2e3e5;
            color: #383d41;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: var(--light-color);
            box-shadow: var(--shadow);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .notification.success {
            background-color: #28a745;
        }
        
        .notification.error {
            background-color: #dc3545;
        }
        
        .notification.show {
            opacity: 1;
        }
        
        @media (max-width: 768px) {
            .menu-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">Bar Ristorante Delizioso</div>
                <div id="current-time"></div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="menu">Menu</div>
            <div class="tab" data-tab="orders">Ordini Correnti</div>
            <div class="tab" data-tab="history">Cronologia</div>
        </div>
        
        <div id="menu" class="tab-content active">
            <h2>Il Nostro Menu</h2>
            <div class="menu-grid" id="menu-grid">
                <!-- Menu items will be loaded here -->
            </div>
            
            <div class="order-summary">
                <h3>Il Tuo Ordine</h3>
                <div class="order-items" id="order-items">
                    <!-- Order items will be displayed here -->
                </div>
                <div class="order-total">
                    <span>Totale:</span>
                    <span id="order-total">€0.00</span>
                </div>
                <div class="order-actions">
                    <button class="btn btn-secondary" id="clear-order">Svuota Ordine</button>
                    <button class="btn btn-primary" id="submit-order">Invia Ordine</button>
                </div>
            </div>
        </div>
        
        <div id="orders" class="tab-content">
            <h2>Ordini Correnti</h2>
            <div class="orders-list" id="current-orders">
                <!-- Current orders will be loaded here -->
            </div>
        </div>
        
        <div id="history" class="tab-content">
            <h2>Cronologia Ordini</h2>
            <div class="orders-list" id="orders-history">
                <!-- Orders history will be loaded here -->
            </div>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>

    <script>
        // Configurazione Supabase
        const SUPABASE_URL = 'https://your-project.supabase.co';
        const SUPABASE_ANON_KEY = 'your-anon-key';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Stato dell'applicazione
        let currentOrder = [];
        let menuItems = [];
        
        // Elementi DOM
        const menuGrid = document.getElementById('menu-grid');
        const orderItems = document.getElementById('order-items');
        const orderTotal = document.getElementById('order-total');
        const clearOrderBtn = document.getElementById('clear-order');
        const submitOrderBtn = document.getElementById('submit-order');
        const currentOrdersList = document.getElementById('current-orders');
        const ordersHistoryList = document.getElementById('orders-history');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const notification = document.getElementById('notification');
        const currentTimeEl = document.getElementById('current-time');
        
        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            loadMenuItems();
            setupEventListeners();
            updateCurrentTime();
            setInterval(updateCurrentTime, 60000); // Aggiorna ogni minuto
            
            // Carica ordini correnti e cronologia
            loadCurrentOrders();
            loadOrdersHistory();
            
            // Ascolta i cambiamenti in tempo reale per gli ordini
            setupRealtimeSubscription();
        });
        
        // Setup degli event listener
        function setupEventListeners() {
            // Tabs
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Pulsanti ordine
            clearOrderBtn.addEventListener('click', clearOrder);
            submitOrderBtn.addEventListener('click', submitOrder);
        }
        
        // Cambia tab
        function switchTab(tabId) {
            tabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            tabContents.forEach(content => {
                if (content.id === tabId) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            // Se si passa al tab degli ordini, ricarica gli ordini
            if (tabId === 'orders') {
                loadCurrentOrders();
            } else if (tabId === 'history') {
                loadOrdersHistory();
            }
        }
        
        // Carica gli elementi del menu da Supabase
        async function loadMenuItems() {
            try {
                const { data, error } = await supabase
                    .from('menu_items')
                    .select('*')
                    .order('category', { ascending: true });
                
                if (error) throw error;
                
                menuItems = data;
                renderMenuItems();
            } catch (error) {
                console.error('Errore nel caricamento del menu:', error);
                showNotification('Errore nel caricamento del menu', 'error');
            }
        }
        
        // Renderizza gli elementi del menu
        function renderMenuItems() {
            menuGrid.innerHTML = '';
            
            menuItems.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.className = 'menu-item';
                menuItem.innerHTML = `
                    <img src="${item.image_url || 'https://via.placeholder.com/300x150?text=Immagine+Prodotto'}" alt="${item.name}">
                    <div class="menu-item-content">
                        <div class="menu-item-title">${item.name}</div>
                        <div class="menu-item-price">€${item.price.toFixed(2)}</div>
                        <p>${item.description || ''}</p>
                        <button class="add-to-order" data-id="${item.id}">Aggiungi all'ordine</button>
                    </div>
                `;
                
                menuGrid.appendChild(menuItem);
            });
            
            // Aggiungi event listener ai pulsanti "Aggiungi all'ordine"
            document.querySelectorAll('.add-to-order').forEach(button => {
                button.addEventListener('click', function() {
                    const itemId = parseInt(this.getAttribute('data-id'));
                    addToOrder(itemId);
                });
            });
        }
        
        // Aggiungi un elemento all'ordine
        function addToOrder(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;
            
            const existingItem = currentOrder.find(i => i.id === itemId);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                currentOrder.push({
                    id: item.id,
                    name: item.name,
                    price: item.price,
                    quantity: 1
                });
            }
            
            updateOrderSummary();
            showNotification(`${item.name} aggiunto all'ordine`, 'success');
        }
        
        // Aggiorna il riepilogo dell'ordine
        function updateOrderSummary() {
            orderItems.innerHTML = '';
            
            if (currentOrder.length === 0) {
                orderItems.innerHTML = '<p>Nessun elemento nell\'ordine</p>';
                orderTotal.textContent = '€0.00';
                return;
            }
            
            let total = 0;
            
            currentOrder.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                const orderItem = document.createElement('div');
                orderItem.className = 'order-item';
                orderItem.innerHTML = `
                    <div>
                        <span>${item.name}</span>
                        <span> (x${item.quantity})</span>
                    </div>
                    <div>€${itemTotal.toFixed(2)}</div>
                `;
                
                orderItems.appendChild(orderItem);
            });
            
            orderTotal.textContent = `€${total.toFixed(2)}`;
        }
        
        // Svuota l'ordine
        function clearOrder() {
            currentOrder = [];
            updateOrderSummary();
            showNotification('Ordine svuotato', 'success');
        }
        
        // Invia l'ordine
        async function submitOrder() {
            if (currentOrder.length === 0) {
                showNotification('Aggiungi almeno un elemento all\'ordine', 'error');
                return;
            }
            
            try {
                const orderData = {
                    items: currentOrder,
                    total: currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                    status: 'pending',
                    created_at: new Date().toISOString()
                };
                
                const { data, error } = await supabase
                    .from('orders')
                    .insert([orderData])
                    .select();
                
                if (error) throw error;
                
                showNotification('Ordine inviato con successo!', 'success');
                clearOrder();
                loadCurrentOrders(); // Ricarica gli ordini correnti
            } catch (error) {
                console.error('Errore nell\'invio dell\'ordine:', error);
                showNotification('Errore nell\'invio dell\'ordine', 'error');
            }
        }
        
        // Carica gli ordini correnti
        async function loadCurrentOrders() {
            try {
                const { data, error } = await supabase
                    .from('orders')
                    .select('*')
                    .neq('status', 'completed')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                renderCurrentOrders(data || []);
            } catch (error) {
                console.error('Errore nel caricamento degli ordini correnti:', error);
                showNotification('Errore nel caricamento degli ordini', 'error');
            }
        }
        
        // Renderizza gli ordini correnti
        function renderCurrentOrders(orders) {
            currentOrdersList.innerHTML = '';
            
            if (orders.length === 0) {
                currentOrdersList.innerHTML = '<p>Nessun ordine corrente</p>';
                return;
            }
            
            orders.forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'order-card';
                
                const orderDate = new Date(order.created_at);
                const formattedDate = `${orderDate.getDate()}/${orderDate.getMonth() + 1}/${orderDate.getFullYear()} ${orderDate.getHours()}:${orderDate.getMinutes().toString().padStart(2, '0')}`;
                
                let itemsHtml = '';
                order.items.forEach(item => {
                    itemsHtml += `<div>${item.name} (x${item.quantity}) - €${(item.price * item.quantity).toFixed(2)}</div>`;
                });
                
                orderCard.innerHTML = `
                    <div class="order-header">
                        <div>Ordine #${order.id}</div>
                        <div class="order-status status-${order.status}">${getStatusText(order.status)}</div>
                    </div>
                    <div>${formattedDate}</div>
                    <div class="order-items">${itemsHtml}</div>
                    <div class="order-total">Totale: €${order.total.toFixed(2)}</div>
                    ${order.status !== 'completed' ? `
                    <div class="order-actions">
                        <button class="btn btn-primary update-status" data-id="${order.id}" data-status="${getNextStatus(order.status)}">${getNextStatusText(order.status)}</button>
                    </div>
                    ` : ''}
                `;
                
                currentOrdersList.appendChild(orderCard);
            });
            
            // Aggiungi event listener ai pulsanti di aggiornamento stato
            document.querySelectorAll('.update-status').forEach(button => {
                button.addEventListener('click', function() {
                    const orderId = this.getAttribute('data-id');
                    const newStatus = this.getAttribute('data-status');
                    updateOrderStatus(orderId, newStatus);
                });
            });
        }
        
        // Carica la cronologia ordini
        async function loadOrdersHistory() {
            try {
                const { data, error } = await supabase
                    .from('orders')
                    .select('*')
                    .eq('status', 'completed')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                renderOrdersHistory(data || []);
            } catch (error) {
                console.error('Errore nel caricamento della cronologia ordini:', error);
                showNotification('Errore nel caricamento della cronologia', 'error');
            }
        }
        
        // Renderizza la cronologia ordini
        function renderOrdersHistory(orders) {
            ordersHistoryList.innerHTML = '';
            
            if (orders.length === 0) {
                ordersHistoryList.innerHTML = '<p>Nessun ordine nella cronologia</p>';
                return;
            }
            
            orders.forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'order-card';
                
                const orderDate = new Date(order.created_at);
                const formattedDate = `${orderDate.getDate()}/${orderDate.getMonth() + 1}/${orderDate.getFullYear()} ${orderDate.getHours()}:${orderDate.getMinutes().toString().padStart(2, '0')}`;
                
                let itemsHtml = '';
                order.items.forEach(item => {
                    itemsHtml += `<div>${item.name} (x${item.quantity}) - €${(item.price * item.quantity).toFixed(2)}</div>`;
                });
                
                orderCard.innerHTML = `
                    <div class="order-header">
                        <div>Ordine #${order.id}</div>
                        <div class="order-status status-${order.status}">${getStatusText(order.status)}</div>
                    </div>
                    <div>${formattedDate}</div>
                    <div class="order-items">${itemsHtml}</div>
                    <div class="order-total">Totale: €${order.total.toFixed(2)}</div>
                `;
                
                ordersHistoryList.appendChild(orderCard);
            });
        }
        
        // Aggiorna lo stato di un ordine
        async function updateOrderStatus(orderId, newStatus) {
            try {
                const { data, error } = await supabase
                    .from('orders')
                    .update({ status: newStatus })
                    .eq('id', orderId)
                    .select();
                
                if (error) throw error;
                
                showNotification(`Stato ordine aggiornato a: ${getStatusText(newStatus)}`, 'success');
                loadCurrentOrders();
                
                // Se siamo nella cronologia, ricarica anche quella
                if (newStatus === 'completed') {
                    loadOrdersHistory();
                }
            } catch (error) {
                console.error('Errore nell\'aggiornamento dello stato:', error);
                showNotification('Errore nell\'aggiornamento dello stato', 'error');
            }
        }
        
        // Configura la sottoscrizione in tempo reale per gli ordini
        function setupRealtimeSubscription() {
            supabase
                .channel('orders-channel')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'orders' 
                    }, 
                    (payload) => {
                        console.log('Cambiamento rilevato:', payload);
                        loadCurrentOrders();
                        
                        // Se l'ordine è stato completato, ricarica anche la cronologia
                        if (payload.eventType === 'UPDATE' && payload.new.status === 'completed') {
                            loadOrdersHistory();
                        }
                    }
                )
                .subscribe();
        }
        
        // Funzioni di utilità
        function getStatusText(status) {
            const statusMap = {
                'pending': 'In Attesa',
                'preparing': 'In Preparazione',
                'ready': 'Pronto',
                'completed': 'Completato'
            };
            
            return statusMap[status] || status;
        }
        
        function getNextStatus(currentStatus) {
            const statusFlow = {
                'pending': 'preparing',
                'preparing': 'ready',
                'ready': 'completed'
            };
            
            return statusFlow[currentStatus] || 'completed';
        }
        
        function getNextStatusText(currentStatus) {
            const nextStatusMap = {
                'pending': 'Inizia Preparazione',
                'preparing': 'Segna come Pronto',
                'ready': 'Segna come Completato'
            };
            
            return nextStatusMap[currentStatus] || 'Completa Ordine';
        }
        
        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        function updateCurrentTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            currentTimeEl.textContent = now.toLocaleDateString('it-IT', options);
        }
    </script>
</body>
</html>
